name: Fast Element benchmark jobs

on: [pull_request]

jobs:
    set_up:
        runs-on: ubuntu-latest
        steps:
        - name: Initialize tachometer comment
          uses: andrewiggins/tachometer-reporter-action@v2
          with:
              initialize: true
        - uses: actions/checkout@v2
          with:
              fetch-depth: 0
        - name: Get yarn cache directory path
          id: yarn-cache-dir-path
          run: echo '::set-output name=dir::$(yarn cache dir)'
        - name: Set up node_modules cache
          uses: actions/cache@v2
          id: yarn-cache
          with:
              path: |
                  ${{ steps.yarn-cache-dir-path.outputs.dir }}
                  node_modules
                  */*/node_modules
              key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
              restore-keys: |
                  ${{ runner.os }}-yarn-
        - name: Install package dependencies
          run: yarn install --frozen-lockfile --ignore-scripts --prefer-offline
        - name: Run tachometer and generate results file
          run: |
              cd packages/utilities/fast-benchmarks
              yarn install
              yarn run benchmark --library=fast-element --benchmark=localTest --versions 1.4.0 1.9.0 --operations=create10k
        - name: Upload results
          uses: actions/upload-artifact@v2
          with:
              name: results-create10k
              path: packages/utilities/fast-benchmarks/results/fast-element_localTest-create10k.json
        - uses: actions/download-artifact@v2
          with:
              name: results-create10k
              path: packages/utilities/fast-benchmarks/results
        # Read all the results and post comment
        - name: Report Tachometer Result
          uses: andrewiggins/tachometer-reporter-action@v2
          with:
              report-id: results-create10k
              path: packages/utilities/fast-benchmarks/results/*.json
